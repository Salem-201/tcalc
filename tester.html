<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار ترافيان - Smart Navigation</title>
    <script src="https://utatar.com/assets/jquery.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background: #f0f0f0; 
            direction: rtl;
        }
        
        /* محاكاة واجهة ترافيان */
        .header {
            background: #8B4513; 
            color: white; 
            padding: 10px; 
            text-align: center;
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000;
        }
        
        .content { 
            margin-top: 60px; 
            padding: 20px; 
            background: white; 
            min-height: calc(100vh - 60px);
        }
        
        .village-info { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 10px 0; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        
        .resources { 
            display: flex; 
            justify-content: space-around; 
            background: #e8e8e8; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        
        .resource { 
            text-align: center;
            padding: 5px;
        }
        
        .navigation { 
            display: flex;
            flex-wrap: wrap;
            gap: 10px; 
            margin: 20px 0;
        }
        
        .nav-btn {
            background: #4CAF50; 
            color: white;
            border: none;
            padding: 10px 15px; 
            border-radius: 5px; 
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn:hover {
            background: #45a049; 
        }
        
        .nav-btn[quick] { 
            background: #2196F3; 
        }
        
        .nav-btn[quick]:hover { 
            background: #1976D2; 
        }
        
        .form-test { 
            background: #fff3cd; 
            padding: 15px; 
            margin: 20px 0;
            border: 1px solid #ffeaa7; 
            border-radius: 5px;
        }
        
        .form-test input { 
            margin: 5px; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 3px;
        }
        
        .form-test button { 
            background: #ff9800; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 3px; 
            cursor: pointer;
        }
        
        .loading {
            display: none;
            background: #ffeb3b; 
            color: #333; 
            padding: 10px; 
            text-align: center;
            margin: 10px 0;
        }
        
        .day { 
            background: #4caf50; 
            color: white; 
            padding: 10px; 
            text-align: center; 
            margin: 10px 0;
        }
        
        .zoom-info { 
            background: #e3f2fd; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #2196f3; 
            border-radius: 5px; 
            text-align: center;
        }
        
        .log { 
            background: #f8f9fa; 
                padding: 10px;
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            margin: 20px 0; 
            height: 200px; 
            overflow-y: auto; 
            font-size: 12px; 
            font-family: monospace;
        }
        
        .clear-btn { 
            background: #f44336; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 3px; 
            cursor: pointer; 
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- محاكاة header ترافيان -->
        <div class="header">
        <h2>🏰 اختبار ترافيان - Smart Navigation</h2>
        </div>

    <!-- محاكاة content ترافيان -->
    <div class="content">
        <!-- معلومات القرية -->
        <div class="village-info">
            <h3>🏘️ قرية الاختبار (100|100)</h3>
            <p>سكان: 1,234 | مستوى: 15</p>
            </div>
            
        <!-- الموارد -->
        <div class="resources">
            <div class="resource">
                <div>🌾</div>
                <div id="l1" title="1000">1,000</div>
            </div>
            <div class="resource">
                <div>🪵</div>
                <div id="l2" title="800">800</div>
            </div>
            <div class="resource">
                <div>⛰️</div>
                <div id="l3" title="600">600</div>
        </div>
            <div class="resource">
                <div>🪙</div>
                <div id="l4" title="400">400</div>
            </div>
        </div>

        <!-- معلومات الزوم -->
        <div class="zoom-info">
            <strong>مستوى الزوم الحالي:</strong> <span id="zoomLevel">100%</span> | 
            <strong>الحالة:</strong> <span id="zoomStatus">طبيعي</span>
        </div>

        <!-- التنقل -->
        <div class="navigation">
            <a href="#" class="nav-btn" quick>🏠 المركز</a>
            <a href="#" class="nav-btn" quick>🏭 الموارد</a>
            <a href="#" class="nav-btn" quick>🔨 البناء</a>
            <a href="#" class="nav-btn" quick>👥 السكان</a>
            <a href="#" class="nav-btn" quick>🗺️ الخريطة</a>
            <a href="#" class="nav-btn" quick>📊 الإحصائيات</a>
        </div>

        <!-- نموذج اختبار -->
        <div class="form-test">
            <h4>📝 اختبار النموذج</h4>
            <form action="#" method="post" quick>
                <input type="text" name="test_input" placeholder="أدخل نص للاختبار" value="اختبار">
                <input type="number" name="test_number" placeholder="رقم" value="123">
                <button type="submit" name="submit" value="submit">إرسال النموذج</button>
            </form>
    </div>

        <!-- مؤشرات التحميل -->
        <div id="loading" class="loading">⏳ جاري التحميل...</div>
        <div id="day" class="day">✅ جاهز</div>

        <!-- سجل الأحداث -->
        <div class="log" id="log"></div>
        <button class="clear-btn" onclick="clearLog()">🗑️ مسح السجل</button>
    </div>

    <!-- محاكاة متغيرات ترافيان -->
    <script>
        // متغيرات ترافيان الأساسية
        let Ll = window.location.href;
        let QuickForm = '0';
        let _isLoading = false;
        let currentCounts = {};
        let _previousGoldValue = null;
        let lastUpdateTime = new Date().getTime();
        let gameTimer;
        let autoRefreshTimer;
        let isLoading = false;
        let countdownElements = [];
        let resourceElements = [];
        let chatEnabled = false;
        let backNavigation = 0;
        let mreq = true;
        let selectedPackageId = null;

        // متغيرات ترافيان المفقودة
        let _mp = {
            mtx: [
                [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null]
            ],
            x: 100,
            y: 100,
            n1: 1,
            n2: 2,
            n3: 3,
            n4: 4,
            n1p7: 1,
            n2p7: 2,
            n3p7: 3,
            n4p7: 4
        };

        let textb = {
            t1: "اختر موقع",
            t2: "واحة",
            t3: "قرية",
            t4: "واحة فارغة",
            f: ["رومان", "توتون", "غال"]
        };

        let GetMap = {};

        function TBI(id) {
            return Math.floor(Math.random() * 20) + 1;
        }

        function SOS(id) {
            return Math.floor(Math.random() * 10) + 1;
        }

        let MapSize = 100;
        let x = 100;
        let y = 100;
        let c13 = false;
        let rad = 3;
        let _OId = [];
        let Trans = false;
        let Freaze = false;
        let active = false;
        let activeItem = null;
        let Show = { style: { display: 'none' } };
        let Crop = { style: { display: 'none' } };

        function CIR(n) {
            return Math.floor(n);
        }

        function Get_Map(ids, type) {
            console.log('Get_Map called with:', ids, type);
        }

        // محاكاة دوال ترافيان الأساسية
        function init(updateInterval = 1) {
            addLog('تم تشغيل init()');
            lastUpdateTime = new Date().getTime();
        }

        function quickLoad(url) {
            addLog(`quickLoad() - URL: ${url}`);
            $("#day").hide();
            $("#loading").show();
            _isLoading = true;
            
            // محاكاة تحميل AJAX
            setTimeout(() => {
                $("#day").show();
                $("#loading").hide();
                _isLoading = false;
                addLog(`تم تحميل: ${url}`);
                
                // محاكاة complete callback
                if (typeof isZoomedIn === 'function' && isZoomedIn()) {
                    addLog('تم كشف الزوم في quickLoad - سيتم إعادة تحميل الصفحة');
                    setTimeout(() => {
                        window.location.href = url;
                    }, 1000);
            } else {
                    addLog('الزوم طبيعي في quickLoad - سيتم التنقل الديناميكي');
                }
            }, 2000);
        }

        function resetZoom() {
            let viewport = document.querySelector("meta[name=viewport]");
            
            if (viewport) {
                viewport.remove();
            }

            viewport = document.createElement("meta");
            viewport.name = "viewport";
            viewport.content = "width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no";
            document.head.appendChild(viewport);

            document.documentElement.style.transform = "scale(1)";
            document.documentElement.style.transformOrigin = "top left";
                
                setTimeout(() => {
                viewport.content = "width=device-width, initial-scale=1, maximum-scale=5, minimum-scale=1, user-scalable=yes";
                document.head.appendChild(viewport);
                document.documentElement.style.transform = "";
            }, 200);
            
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function quickPost() {
            addLog('تم تشغيل quickPost()');
        }

        // دوال مساعدة
        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateZoomInfo() {
            if (typeof getZoomLevel === 'function') {
                const zoom = getZoomLevel();
                const percentage = Math.round(zoom * 100);
                document.getElementById('zoomLevel').textContent = percentage + '%';
                document.getElementById('zoomStatus').textContent = isZoomedIn() ? 'مكبر' : 'طبيعي';
            }
        }

        // تهيئة الصفحة
        $(document).ready(function() {
            addLog('تم تحميل الصفحة');
            addLog('تم تهيئة متغيرات ترافيان');
            
            // تحديث معلومات الزوم كل ثانية
            setInterval(updateZoomInfo, 1000);
            updateZoomInfo();
        });
    </script>

    <!-- تحميل الكود الحقيقي -->
    <script src="https://salem-201.github.io/tcalc/javautt_V1.0.js"></script>
    
    <!-- إضافة الكود المطلوب للاختبار -->
    <script>
        // إضافة دوال الزوم المطلوبة
        function getZoomLevel() {
            if (window.visualViewport && window.visualViewport.scale) {
                return window.visualViewport.scale;
            }
            const screenWidth = window.screen.width;
            const windowWidth = window.innerWidth;
            const zoom = screenWidth / windowWidth;
            return zoom;
        }

        function isZoomedIn() {
            const zoom = getZoomLevel();
            return zoom > 1.1;
        }

        function smartNavigation(url) {
            if (isZoomedIn()) {
                addLog('smartNavigation: تم كشف الزوم - سيتم إعادة تحميل الصفحة');
                window.location.href = url;
                                } else {
                addLog('smartNavigation: الزوم طبيعي - سيتم التنقل الديناميكي');
                quickLoad(url);
            }
        }

        // إضافة event listeners للاختبار
        $(document).ready(function() {
            // إضافة click handler للروابط
            $(document).off("click","a[quick], area[quick]").on("click","a[quick], area[quick]",function(event){
                if (event.ctrlKey || _isLoading || $(this).attr("href")===location.href.split('/').pop()) {
                    return event.ctrlKey;
                }
                const href = $(this).attr("href");
                if (!href || href.includes('#')) return false;
                event.preventDefault();
                $("#day").hide();
                $("#loading").show();
                _isLoading = true;
                addLog(`تم النقر على رابط: ${href}`);
                smartNavigation(href);
                return false;
            });

            // إضافة submit handler للنماذج
            $(document).off("submit", "form[quick]").on("submit", "form[quick]", function(event) {
                event.preventDefault();
                addLog('تم إرسال النموذج');
                if (isZoomedIn()) {
                    addLog('تم كشف الزوم في النموذج - سيتم إعادة تحميل الصفحة');
                setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                            } else {
                    addLog('الزوم طبيعي في النموذج - سيتم التنقل الديناميكي');
                }
            });
        });
    </script>
</body>
</html>
